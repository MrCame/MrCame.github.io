<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head><meta name="generator" content="Hexo 3.9.0">
  

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5">



  
    <link href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  


<link rel="stylesheet" type="text/css" href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0">

<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.2">




  <meta name="keywords" content="Hexo,next">





  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2">


<meta property="og:type" content="website">
<meta property="og:title" content="Welcome to My World">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Welcome to My World">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Welcome to My World">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'always'
  };
</script>



  <title> Welcome to My World </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Welcome to My World</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">
    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2019/05/24/Future/" itemprop="url">
                  Future
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2019-05-24T14:45:59+08:00" content="2019-05-24">
              2019-05-24
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>Callableæä¾›äº†å¸¦è¿”å›å€¼çš„å­çº¿ç¨‹æ‰§è¡Œç»“æœï¼ŒFutureæä¾›äº†è·å–å­çº¿ç¨‹ç»“æœçš„é€”å¾„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Callable&lt;String&gt; callable = () -&gt; <span class="keyword">null</span>;</span><br><span class="line">ExecutorService executor = Executors.newSingleThreadExecutor();</span><br><span class="line">Future&lt;String&gt; future = executor.submit(callable);</span><br><span class="line">System.out.println(future.get());</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ï¼Œè¿™ç§ç›´æ¥<code>get()</code>çš„æ–¹å¼æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œå½“ç„¶ï¼Œå¦‚æœè½®è¯¢<code>isDone()</code>çš„è¯ä»ç„¶æ˜¯æ¢æ±¤ä¸æ¢è¯ã€‚å…³äºè€ç”Ÿå¸¸è°ˆçš„åŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡ï¼Œè¿™ç¯‡<a href="https://mp.weixin.qq.com/s/uDgueoMIEjl-HCE_fcSmSw" target="_blank" rel="noopener">ã€ŠI/Oæ¨¡å‹ã€‹</a>ä»Javaçš„è§†è§’å‡ºå‘æ¥è®²è§£ï¼Œç‰¹åˆ«æ˜¯<code>NIO</code>å’Œ<code>AIO</code>ï¼ŒæŒ‡å‡º<code>AIO</code>å¹¶ä¸æ˜¯å­—é¢ä¸Šçš„å¼‚æ­¥å«ä¹‰ï¼Œå€¼å¾—ä¸€çœ‹ã€‚<br>é‚£ä¹ˆå¯¹äº<code>Future</code>æ¨¡å¼ï¼Œé™¤äº†ä¸Šæ–‡çš„å°†æ¥å¼<code>get()</code>è¿™ç§ä¸ä¼˜é›…çš„åŒæ­¥é˜»å¡æ–¹æ¡ˆï¼Œè¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹å¼å¯ä»¥æ‹¿åˆ°å­çº¿ç¨‹ç»“æœå‘¢ï¼Ÿ<br>å¾ˆå®¹æ˜“æƒ³åˆ°çš„ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨å›è°ƒã€‚å¦‚<code>AIO</code>æä¾›äº†<code>java.nio.channels.CompletionHandler</code>ä½œä¸ºå›è°ƒæ¥å£ï¼Œå½“I/Oæ“ä½œç»“æŸåï¼Œç³»ç»Ÿå°†ä¼šè°ƒç”¨<code>CompletionHandler</code>çš„<code>completed</code>æˆ–<code>failed</code>æ–¹æ³•æ¥ç»“æŸä¸€æ¬¡è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Server */</span></span><br><span class="line">AsynchronousChannelGroup channelGroup = AsynchronousChannelGroup</span><br><span class="line">        .withThreadPool(executor);</span><br><span class="line">AsynchronousServerSocketChannel serverChannel = AsynchronousServerSocketChannel</span><br><span class="line">        .open(channelGroup)</span><br><span class="line">        .bind(<span class="keyword">new</span> InetSocketAddress(serverPort));</span><br><span class="line">serverChannel.accept(</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">new</span> CompletionHandler&lt;AsynchronousSocketChannel, Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(AsynchronousSocketChannel result, Object attach)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// doSomething()</span></span><br><span class="line">                serverChannel.accept(<span class="keyword">null</span>, <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, Object attach)</span> </span>&#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Client */</span></span><br><span class="line">AsynchronousSocketChannel clientChannel = AsynchronousSocketChannel.open();</span><br><span class="line">clientChannel.connect(<span class="keyword">new</span> InetSocketAddress(clientPort));</span><br><span class="line">clientChannel.read(</span><br><span class="line">        ByteBuffer.allocate(<span class="number">1024</span>),</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">new</span> CompletionHandler&lt;Integer, Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, Object attachment)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// doSomething()</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, Object attachment)</span> </span>&#123; &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p><code>JDK5</code>çš„<code>NIO</code>å·²ç»æä¾›äº†ç›¸å…³çš„APIï¼Œè™½ç„¶æ“ä½œæ›´ä¸ºå¤æ‚ä¸€äº›ï¼Œä½†åœ¨æ­¤åŸºç¡€ä¸Šï¼Œè¯¸å¦‚<code>Netty</code>ç­‰é€šä¿¡æ¡†æ¶å·²ç»å‘å±•çš„ååˆ†ç¹è£ã€‚<code>AIO</code>ä¼¼ä¹å¹¶æ²¡æœ‰è¾¾åˆ°é¢„è®¡çš„æ•ˆæœï¼Œä½†è¿™ç§å›è°ƒæ–¹å¼æ˜¾ç„¶è¦æ¯”ç›´æ¥<code>get()</code>çš„ç²—æš´æ–¹å¼è¦æ›´ä¸ºä¼˜é›…ã€‚<br>é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸é‚£ä¹ˆç²—æš´åˆæ–¹ä¾¿ä¸€äº›çš„å›è°ƒæ–¹æ¡ˆå‘¢ï¼Ÿ<br>ç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œä¸€äº›å¼€æºçš„å·¥å…·å·²ç»ä¸ºæˆ‘ä»¬æä¾›äº†è¿™ä¸ªåŠŸèƒ½ï¼Œä¾‹å¦‚æ¥ä¸‹æ¥è¦ä»‹ç»çš„Googleæ‰©å±•åŒ…<code>Guava</code>ä¸­æä¾›çš„å¹¶å‘å·¥å…·<code>com.google.common.util.concurrent.ListenableFuture</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¯¹jdkæä¾›çš„çº¿ç¨‹æ± è¿›è¡Œä¿®é¥°ï¼Œç”¨äºè¿”å›ListenabledFuture</span></span><br><span class="line">    ListeningExecutorService executorService = MoreExecutors</span><br><span class="line">            .listeningDecorator(Executors.newCachedThreadPool());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  æäº¤ä¸€ä¸ªCallableï¼Œè¿”å›ListenableFuture</span></span><br><span class="line">    <span class="keyword">final</span> ListenableFuture&lt;Integer&gt; listenableFuture = executorService.submit(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">"call execute.."</span>);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ºlistenableFutureæ·»åŠ å›è°ƒå‡½æ•°ï¼Œæ²¡æœ‰ä»»ä½•å¼‚å¸¸åˆ™åˆ†æ”¯è¿›å…¥onSuccesså¤„ç†ï¼Œå¦åˆ™è¿›å…¥onFailureåˆ†æ”¯</span></span><br><span class="line">    Futures.addCallback(listenableFuture,  <span class="keyword">new</span> FutureCallback() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"å¼‚æ­¥å¤„ç†æˆåŠŸ,result="</span>+o);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"å¼‚æ­¥å¤„ç†å¤±è´¥,e="</span>+throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, MoreExecutors.directExecutor());</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"ä¸ä¼šé˜»å¡"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å’Œ<code>Future</code>çš„<code>get()</code>ä¼šé˜»å¡ä¸»çº¿ç¨‹ä¸åŒï¼Œå¸¦ç›‘å¬å™¨çš„<code>ListenableFuture</code>å¯ä»¥å¼‚æ­¥å¤„ç†<code>Callable</code>ç»“æœï¼Œæœ€ç»ˆæ‰“å°ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call execute..</span><br><span class="line">ä¸ä¼šé˜»å¡</span><br><span class="line">å¼‚æ­¥å¤„ç†æˆåŠŸ,result=7</span><br></pre></td></tr></table></figure>

<p>ä»<code>ListeningExecutorService</code>è¿™ä¸ªä¿®é¥°åçš„çº¿ç¨‹æ± å‡ºå‘ï¼Œçœ‹çœ‹å¦‚ä½•ä¿®é¥°åå¦‚ä½•å°†æäº¤çš„<code>Callable</code>è¾“å‡ºä¸º<code>ListenableFuture</code>ï¼Œè€Œé<code>Future</code>ï¼Œä¸»è¦æ¥çœ‹<code>submit</code>æ–¹æ³•ã€‚<br><img src="/images/future1.jpg" alt="&quot;AbstractListeningExecutorService&quot;"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractListeningExecutorService</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ListeningExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">ListenableFuture&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (ListenableFuture&lt;T&gt;) <span class="keyword">super</span>.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">RunnableFuture&lt;T&gt; <span class="title">newTaskFor</span><span class="params">(Callable&lt;T&gt; callable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TrustedListenableFutureTask.create(callable);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractExecutorService</span> <span class="keyword">implements</span> <span class="title">ExecutorService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</span><br><span class="line">        execute(ftask);</span><br><span class="line">        <span class="keyword">return</span> ftask;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">RunnableFuture&lt;T&gt; <span class="title">newTaskFor</span><span class="params">(Callable&lt;T&gt; callable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FutureTask&lt;T&gt;(callable);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„<code>submit</code>å’Œ<code>newTaskFor</code>æœ€ç»ˆæ‰§è¡Œçš„éƒ½æ˜¯å­ç±»<code>AbstractListeningExecutorService</code>ä¸­çš„ï¼Œè¿™æ˜¯<code>Guava</code>åŒ…å†…çš„ï¼Œè€Œé<code>J.C.U</code>åŒ…å†…çš„<code>AbstractExecutorService</code>ï¼Œè¿”å›äº†<code>TrustedListenableFutureTask</code>çš„å®ä¾‹ï¼Œçœ‹ä¸€ä¸‹ä¾èµ–å…³ç³»ï¼Œèƒ½å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°è¿™æ˜¯<code>ListenableFuture</code>çš„ä¸€ä¸ªå®ç°ç±»ã€‚<br><img src="/images/future2.jpg" alt="&quot;AbstractListeningExecutorService&quot;"><br>é‚£ä¹ˆæ˜¯å¦‚ä½•è¿›è¡Œå›è°ƒçš„å‘¢ï¼Ÿæ¥ç€ä»åˆšæ‰çš„å®ç°ç±»<code>TrustedListenableFutureTask</code>æ¥çœ‹ï¼Œä¸»è¦åšçš„å·¥ä½œæ˜¯<code>InterruptibleTask</code>é‡Œï¼Œå®ç°äº†<code>Runnable</code>çš„<code>run</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrustedListenableFutureTask</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">FluentFuture</span>.<span class="title">TrustedFuture</span>&lt;<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">RunnableFuture</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> InterruptibleTask&lt;?&gt; task;</span><br><span class="line"></span><br><span class="line">    TrustedListenableFutureTask(Callable&lt;V&gt; callable) &#123;</span><br><span class="line">        <span class="keyword">this</span>.task = <span class="keyword">new</span> TrustedFutureInterruptibleTask(callable);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">InterruptibleTask</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AtomicReference</span>&lt;<span class="title">Runnable</span>&gt; <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// DoNothingRunnableä»€ä¹ˆä¹Ÿä¸åšï¼Œç©ºè½¬</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Runnable DONE = <span class="keyword">new</span> DoNothingRunnable();  <span class="comment">// å®Œæˆä¸­æ–­ï¼Œç½®ä¸ºDONE</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Runnable INTERRUPTING = <span class="keyword">new</span> DoNothingRunnable();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Runnable PARKED = <span class="keyword">new</span> DoNothingRunnable();</span><br><span class="line">    <span class="comment">// Why 1000?  WHY NOT!  ã€ğŸ˜ã€‘</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_BUSY_WAIT_SPINS = <span class="number">1000</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread currentThread = Thread.currentThread();</span><br><span class="line">        <span class="keyword">if</span> (!compareAndSet(<span class="keyword">null</span>, currentThread)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// å·²ç»æœ‰å…¶ä»–è¿è¡Œçš„çº¿ç¨‹ï¼ŒCASå¤±è´¥</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> run = !isDone();</span><br><span class="line">        T result = <span class="keyword">null</span>;</span><br><span class="line">        Throwable error = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (run) &#123; </span><br><span class="line">                result = runInterruptibly();  <span class="comment">// æœ€ç»ˆæ‰§è¡Œäº†callable.call()</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            error = t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// å°è¯•å°†å½“å‰çº¿ç¨‹ç½®ä¸ºDONE</span></span><br><span class="line">            <span class="keyword">if</span> (!compareAndSet(currentThread, DONE)) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> restoreInterruptedBit = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">int</span> spinCount = <span class="number">0</span>;</span><br><span class="line">                Runnable state = get();</span><br><span class="line">                <span class="keyword">while</span> (state == INTERRUPTING || state == PARKED) &#123;</span><br><span class="line">                    spinCount++;</span><br><span class="line">                    <span class="comment">// è¶…è¿‡æœ€å¤§è‡ªæ—‹æ¬¡æ•°</span></span><br><span class="line">                    <span class="keyword">if</span> (spinCount &gt; MAX_BUSY_WAIT_SPINS) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (state == PARKED || compareAndSet(INTERRUPTING, PARKED)) &#123;</span><br><span class="line">                            <span class="comment">// æ¢å¤ä¸­æ–­æ ‡å¿—ä½</span></span><br><span class="line">                            restoreInterruptedBit = Thread.interrupted()||restoreInterruptedBit;</span><br><span class="line">                            LockSupport.park(<span class="keyword">this</span>);  <span class="comment">// é˜»å¡çº¿ç¨‹</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Thread.yield();  <span class="comment">// è‡ªæ—‹è®©æ­¥</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    state = get();  <span class="comment">// æ›´æ–°çŠ¶æ€</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (restoreInterruptedBit) &#123;</span><br><span class="line">                    currentThread.interrupt();  <span class="comment">// æœ‰ä¸­æ–­</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å®Œæˆä¸­æ–­</span></span><br><span class="line">            <span class="keyword">if</span> (run) &#123;</span><br><span class="line">                afterRanInterruptibly(result, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨runInterruptiblyä¹‹å‰è°ƒç”¨ï¼Œå¦‚æœæ˜¯trueï¼ŒrunInterruptiblyå’ŒafterRanInterruptiblyä¸å†è°ƒç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸è®¡ç®—Futuresçš„ç»“æœï¼Œåªå¤„ç†å¯ä¸­æ–­ä»»åŠ¡ï¼Œå› ä¸ºlisteneræœ‰å¯èƒ½è¢«ä¸­æ–­</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> T <span class="title">runInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—Futuresçš„ç»“æœï¼Œä»»ä½•è°ƒç”¨interruptTaskå‘ç”Ÿçš„ä¸­æ–­ï¼Œéƒ½åœ¨æ­¤æ–¹æ³•è¢«è°ƒç”¨å‰å‘ç”Ÿ</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">afterRanInterruptibly</span><span class="params">(@Nullable T result, @Nullable Throwable error)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2019/05/21/AQS-4/" itemprop="url">
                  AQSæºç è§£æï¼ˆ4ï¼‰â€”â€”æ€»ç»“
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2019-05-21T14:03:38+08:00" content="2019-05-21">
              2019-05-21
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>è¿™é‡Œæ€»ç»“ä¸€ä¸‹<code>lock()</code>å’Œ<code>unlock()</code>çš„æ•´ä½“è¿‡ç¨‹<br><img src="/images/lock.jpg" alt="&quot;lock&quot;"><br><img src="/images/unlock.jpg" alt="&quot;unlock&quot;"><br>å‚è€ƒ<br>[1] <a href="https://www.cnblogs.com/waterystone/p/4920797.html" target="_blank" rel="noopener">Javaå¹¶å‘ä¹‹AQSè¯¦è§£</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2019/05/16/AQS-3/" itemprop="url">
                  AQSæºç è§£æï¼ˆ3ï¼‰
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2019-05-16T17:24:24+08:00" content="2019-05-16">
              2019-05-16
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>ä¸Šä¸€ç¯‡<a href="http://mrcame.github.io/2019/05/13/AQS-2/" target="_blank" rel="noopener">AQSæºç è§£æ(2)</a>ï¼Œå­¦ä¹ äº†<code>ReentrantLock</code>çš„åŠ é”è¿‡ç¨‹ï¼Œå¯¹ç…§åœ°æ¥çœ‹ä¸€ä¸‹å¦‚ä½•é‡Šæ”¾é”ã€‚ä¸åŠ é”æœ‰ä¸€äº›ä¸åŒçš„åœ°æ–¹æ˜¯ï¼Œé‡Šæ”¾æ—¶ç›´æ¥å°±<code>release(1)</code>ï¼Œè¿™æ˜¯åœ¨AQSä¸­å®ç°çš„ï¼Œä¸åƒåŠ é”æ—¶åœ¨<code>Sync</code>çš„å­ç±»ä¸­æ‰å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123; </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;&#125;  <span class="comment">// è§ä¸‹æ–‡</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒæ–¹æ³•æœ‰ä¸¤ä¸ª<code>tryRelease()</code>å’Œ<code>unparkSuccessor()</code>ï¼Œçœ‹è¿‡åŠ é”å®ç°ï¼Œåº”è¯¥ä¹Ÿèƒ½çŒœåˆ°ï¼Œ<code>tryRelease</code>åº”è¯¥æ˜¯åœ¨å­ç±»ä¸­æ‰å®ç°çš„ï¼Œæœä¸å…¶ç„¶ï¼ŒAQSé‡Œåªæ˜¯å®šä¹‰ï¼Œä½†ä¸åƒåŠ é”é‚£æ ·åˆ†ä¸ºå…¬å¹³/éå…¬å¹³å„è‡ªå®ç°ã€‚è€Œåè€…ä»åå­—èƒ½çŒœåˆ°ï¼Œæ˜¯è¦å”¤é†’é“¾è¡¨ä¸­çš„åç»­èŠ‚ç‚¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** AbstractQueuedSynchronizer.java **/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tryRelease(arg)) &#123;  <span class="comment">// å°è¯•é‡Šæ”¾èµ„æº</span></span><br><span class="line">            Node h = head;</span><br><span class="line">            <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">                unparkSuccessor(h);  <span class="comment">// å”¤é†’å¤´èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** ReentrantLock#Sync.java **/</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹ä¸æ˜¯ç‹¬å çš„ï¼ŒæŠ›å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;  <span class="comment">// ä¹‹å‰acquire(1)ï¼Œç°åœ¨releases(1)</span></span><br><span class="line">            free = <span class="keyword">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;         </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥<code>ReentrantLock</code>ä¸ºä¾‹ï¼Œ<code>lock()</code>æœ¬è´¨ä¸Šå°±æ˜¯<code>acquire(1)</code>çš„è¿‡ç¨‹ï¼Œåœ¨<code>unlock()</code>æ—¶åªéœ€é‡Šæ”¾æ‰è¿™æ‹¿åˆ°çš„1ä¸ªçŠ¶æ€èµ„æºï¼Œæ¥ç€åˆ†æä¸Šä¸€ç¯‡ä¸­é—ç•™çš„<code>unparkSuccessor()</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** AbstractQueuedSynchronizer.java **/</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">            compareAndSetWaitStatus(node, ws, <span class="number">0</span>);  <span class="comment">// èŠ‚ç‚¹ç½®ä¸ºæ— çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰¾åˆ°åç»­èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯nullæˆ–è€…æ˜¯CANCELLEDçŠ¶æ€çš„è¯ï¼Œä»å°¾èŠ‚ç‚¹å‘å‰æ‰¾</span></span><br><span class="line">        Node s = node.next;</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            s = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">                <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                    s = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">            LockSupport.unpark(s.thread);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œå¯ä»¥çœ‹åˆ°<code>Reentrant</code>çš„æ•´ä¸ª<code>lock()</code>å’Œ<code>unlock()</code>è¿‡ç¨‹ï¼Œå½“èŠ‚ç‚¹<code>acquire</code>æˆåŠŸæ—¶ï¼Œç½®ä¸ºå¤´èŠ‚ç‚¹ï¼ŒåŒæ—¶å…¶ä»–èŠ‚ç‚¹ä¹Ÿåœ¨<code>acquire</code>,å¾—ä¸åˆ°ç«æ€èµ„æº(state)å°±å…¥é˜Ÿè‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°æŒæœ‰èµ„æºçš„å¤´èŠ‚ç‚¹é‡Šæ”¾ï¼Œå¹¶å”¤é†’å…¶åç»­èŠ‚ç‚¹ã€‚</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2019/05/13/AQS-2/" itemprop="url">
                  AQSæºç è§£æï¼ˆ2ï¼‰
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2019-05-13T17:55:22+08:00" content="2019-05-13">
              2019-05-13
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>ä¸Šä¸€ç¯‡ <a href="http://mrcame.github.io/2019/05/10/AQS-1/" target="_blank" rel="noopener">AQSæºç è§£æ(1)</a>å·²ç»ä»‹ç»äº†AQSçš„æ•°æ®ç»“æ„ã€‚åœ¨è¿™ç¯‡ï¼Œå°†ä»J.U.Cé‡Œçš„è®¸å¤šåŸºäºAQSå®ç°çš„åŒæ­¥å·¥å…·å‡ºå‘ï¼Œçœ‹ä¸€çœ‹AQSåˆ°åº•æä¾›äº†å“ªäº›åŠŸèƒ½ã€‚<br>æ¯”å¦‚<code>Lock lock = new ReentrantLock()</code>ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”çš„å®ç°ï¼Œä½¿ç”¨<code>lock()</code>ã€<code>unlock()</code>è¿›è¡ŒåŒæ­¥ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹å¦‚ä½•åŠ é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      sync = <span class="keyword">new</span> NonfairSync(); </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123; </span><br><span class="line">      sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync(); </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123; </span><br><span class="line">      sync.lock(); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123; </span><br><span class="line">      <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;&#125;  <span class="comment">// è§ä¸‹æ–‡</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;&#125;  <span class="comment">// è§ä¸‹æ–‡</span></span><br><span class="line">    &#125;       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹ä»£ç è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œæ ¸å¿ƒå°±åœ¨<code>acquire()</code>ä¸­ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨çˆ¶ç±»AQSå†…å®šä¹‰å®ç°çš„ï¼Œè€Œ<code>tryAcquire()</code>åœ¨AQSå†…åªç»™äº†å®šä¹‰ï¼Œå…·ä½“å®ç°è¿˜æ˜¯åœ¨å­ç±»ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** AbstractQueuedSynchronizer.java **/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// tryAcquireå¤±è´¥ï¼Œå°†ç‹¬å æ¨¡å¼èŠ‚ç‚¹å…¥é˜Ÿï¼Œå†ä»é˜Ÿåˆ—ä¸­è·å–</span></span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))  </span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥<code>ReentrantLock</code>ä¸ºä¾‹ï¼Œå†…éƒ¨ç±»<code>Sync</code>çš„å­ç±»<code>FairSync</code>å’Œ<code>NonFairSync</code>åˆ†åˆ«å®ç°äº†å…¬å¹³é”ä¸éå…¬å¹³é”ã€‚è¿™æ—¶èƒ½æ¸…æ¥šçœ‹åˆ°ï¼Œåœ¨AQSä¸­ç”¨æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€çš„<code>state</code>ï¼Œä¼šéšç€æ¯æ¬¡<code>acquire()</code>è€Œä»<code>0</code>å¼€å§‹ç´¯åŠ ã€‚åŒç†æ¯æ¬¡<code>release()</code>ä¼šå‡å°‘ç›´åˆ°ä¸º<code>0</code>ï¼Œå½“<code>state == 0</code>å¯ä»¥è®¤ä¸ºèµ„æºéƒ½è¢«é‡Šæ”¾ï¼Œå…¬å¹³é”éœ€è¦æŠŠèµ„æºè®©ç»™ç­‰å¾…æ›´ä¹…çš„çº¿ç¨‹ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰èµ„æºï¼Œå¯ä»¥ç»§ç»­å¢åŠ <code>state</code>ï¼Œæ— éœ€é‡æ–°ç­‰å¾…ç«äº‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ„ä¹‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** ReentrantLock#FairSync.java å…¬å¹³é”tryAcquireå®ç° **/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();  <span class="comment">// volatile int state</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å…¬å¹³é”ï¼šéœ€è¦å…ˆçœ‹çœ‹æ˜¯ä¸æ˜¯æœ‰çº¿ç¨‹æ¯”å½“å‰çº¿ç¨‹ç­‰çš„æ›´ä¹…ï¼Œæ²¡æœ‰çš„è¯å†acquireèµ„æº</span></span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);  <span class="comment">// è®¾ç½®å½“å‰çº¿ç¨‹ç‹¬å </span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ç‹¬å ï¼Œæ— éœ€ç­‰å¾…å†æ¬¡è¿›å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** ReentrantLock#NonfairSync.java éå…¬å¹³é”tryAcquireå®ç° **/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquire(acquires);  <span class="comment">// çˆ¶ç±»Syncä¸­çš„nonfairTryAcquireæ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// éå…¬å¹³é”ï¼šä¸ç”¨hasQueuedPredecessorsï¼Œç›´æ¥acquireèµ„æº</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);  <span class="comment">// è®¾ç½®å½“å‰çº¿ç¨‹ç‹¬å </span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ç‹¬å ï¼Œæ— éœ€ç­‰å¾…å†æ¬¡è¿›å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>tryAcquire(arg)</code>å¤±è´¥ï¼Œå°†åˆ›å»ºç‹¬å æ¨¡å¼èŠ‚ç‚¹å…¥é˜Ÿï¼Œ<code>addWaiter(Node.EXCLUSIVE)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** AbstractQueuedSynchronizer.java **/</span>    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">        Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);  <span class="comment">// èŠ‚ç‚¹ä¸å½“å‰çº¿ç¨‹å…³è”ï¼Œå¹¶è®¾ç½®æ¨¡å¼</span></span><br><span class="line">        <span class="comment">// å°è¯•å¿«é€Ÿæ–¹å¼å…¥é˜Ÿ</span></span><br><span class="line">        Node pred = tail;</span><br><span class="line">        <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">            node.prev = pred;</span><br><span class="line">            <span class="comment">// å¦‚æœå¤šä¸ªçº¿ç¨‹å°è¯•å…¥é˜Ÿï¼Œæ“ä½œå¿…é¡»æ˜¯åŸå­çš„ï¼Œå°†å°¾èŠ‚ç‚¹è®¾ç½®ä¸ºnode</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">                pred.next = node;</span><br><span class="line">                <span class="keyword">return</span> node;  <span class="comment">// è¿”å›æ–°èŠ‚ç‚¹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¿«é€Ÿæ–¹å¼å¤±è´¥ï¼Œè‡ªæ—‹å…¥é˜Ÿ</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="keyword">return</span> node;  <span class="comment">// è¿”å›å…ˆå‰èŠ‚ç‚¹</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            Node t = tail;</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                    tail = head;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                node.prev = t;</span><br><span class="line">                <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                    t.next = node;</span><br><span class="line">                    <span class="keyword">return</span> t;  <span class="comment">// è¿”å›å…ˆå‰èŠ‚ç‚¹</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è¿›è¡Œåˆ°æ­¤ï¼Œå†å›é¡¾ä¸€ä¸‹ï¼š<code>!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code><br><code>acquireQueued()</code>å°†å¼€å§‹ä»é˜Ÿåˆ—ä¸­è‡ªæ—‹è·å–åˆšåŠ å…¥çš„èŠ‚ç‚¹ï¼Œä¸»è¦åšçš„å°±æ˜¯ä¸‰ä»¶äº‹ï¼Œä¸€æ˜¯å°†æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å¤´èŠ‚ç‚¹ï¼ŒäºŒæ˜¯ç»™ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹è°ƒæ•´åˆ°æœ€è¿‘çš„ä¸€ä¸ªé<code>CANCELLED</code>èŠ‚ç‚¹åï¼Œå¹¶ä¸”å°†å…¶å…ˆå‰èŠ‚ç‚¹çš„çŠ¶æ€ä¿®æ”¹ä¸º<code>SIGNAL</code>ï¼Œä¸‰æ˜¯ä½¿ç”¨<code>LockSupport.park</code>å°†åˆé€‚èŠ‚ç‚¹çš„çº¿ç¨‹ä¼‘çœ ï¼Œæœ€ç»ˆè¿”å›ç»“æœè¡¨ç¤ºå½“çº¿ç¨‹ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ä¸­æ–­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹æ»¡è¶³æ¡ä»¶ï¼šæ˜¯ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”acquireæˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼Œè¿™é‡Œä¸ç”¨CASï¼Œå› ä¸ºå·²ç»acquireåˆ°èµ„æº</span></span><br><span class="line">                setHead(node);  </span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GCï¼Œå›æ”¶æ—§çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹ä¸æ»¡è¶³æ¡ä»¶ï¼Œè°ƒæ•´èŠ‚ç‚¹ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œä¼‘çœ çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;  <span class="comment">// åªè¦æœ‰ä¸€æ¬¡ä¸­æ–­ï¼Œå°±å°†ä¸­æ–­æ ‡å¿—è®¾ç½®ä¸ºtrue</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;  <span class="comment">// returnå‰ï¼Œå…ˆæ£€æŸ¥failedï¼Œå¦‚æœå‡ºç°å¼‚å¸¸åˆ™å–æ¶ˆè¯¥èŠ‚ç‚¹çš„acquire</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)  <span class="comment">// å…ˆå‰èŠ‚ç‚¹çŠ¶æ€å·²ç»æ˜¯SIGNALï¼Œå½“å‰èŠ‚ç‚¹ä½ç½®å®‰å…¨ï¼Œå¯ä»¥ä¼‘çœ </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="comment">// å…ˆå‰èŠ‚ç‚¹çŠ¶æ€æ˜¯CANCELLEDï¼Œå°†å½“å‰èŠ‚ç‚¹è°ƒæ•´åˆ°æœ€è¿‘çš„ä¸€ä¸ªéCANCELLEDèŠ‚ç‚¹å</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å…ˆå‰èŠ‚ç‚¹çŠ¶æ€ä¸æ˜¯CANCELLEDï¼ŒCASä¸ºSIGNAL</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ­¤æ—¶åªæ˜¯å°†å…ˆå‰èŠ‚ç‚¹çŠ¶æ€ä¿®æ”¹ï¼Œä½†è€ƒè™‘åˆ°å¹¶å‘æƒ…å†µï¼Œä¹Ÿæœ‰å…¶ä»–çº¿ç¨‹åœ¨åšåŒæ ·çš„äº‹æƒ…ï¼Œéœ€è¦å†æ¬¡è‡ªæ—‹æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);  <span class="comment">// é˜»å¡çº¿ç¨‹ï¼Œè¢«unparkæˆ–è¢«interruptå¯ä»¥å”¤é†’</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();  <span class="comment">// è¿”å›çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­è¿‡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    node.thread = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// è·³è¿‡CANCELLEDçŠ¶æ€çš„å…ˆå‰èŠ‚ç‚¹ï¼Œè°ƒæ•´è¯¥èŠ‚ç‚¹predåŸŸ</span></span><br><span class="line">    Node pred = node.prev;</span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line">    Node predNext = pred.next;  <span class="comment">// å…ˆå‰èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹æ˜¯é˜Ÿå°¾ï¼Œå°†å…ˆå‰èŠ‚ç‚¹è®¾ç½®ä¸ºé˜Ÿå°¾ï¼Œç„¶åå°†å…¶nextåŸŸç½®ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">// ä¸æ˜¯é˜Ÿå°¾</span></span><br><span class="line">        <span class="comment">// å…ˆå‰èŠ‚ç‚¹åŒæ—¶å¦‚ä¸‹æ»¡è¶³æ¡ä»¶ï¼šä¸æ˜¯å¤´èŠ‚ç‚¹ã€çŠ¶æ€æ˜¯SIGNALæˆ–è€…å¯ä»¥å˜ä¸ºSIGNALã€ç»‘å®šäº†çº¿ç¨‹</span></span><br><span class="line">        <span class="comment">// å°†å…¶predèŠ‚ç‚¹çš„nextåŸŸç½®ä¸ºè¯¥èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">int</span> ws;</span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Node next = node.next;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            unparkSuccessor(node);  <span class="comment">// å”¤é†’åç»­èŠ‚ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        node.next = node; <span class="comment">// help GCï¼Œä½¿CANCELLEDçŠ¶æ€çš„èŠ‚ç‚¹ä¸å¯è¾¾ï¼Œè¢«GCå›æ”¶</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨çœ‹æºç æ—¶æœ‰ä¸€ä¸ªé—®é¢˜å›°æ‰°ç€æˆ‘ï¼Œä¸ºä»€ä¹ˆåœ¨<code>shouldParkAfterFailedAcquire</code>æ—¶ä¸€å®šæ˜¯ä»å°¾å‘å¤´å»æ‰¾ï¼Œè€Œä¸æ˜¯åè¿‡æ¥å‘¢ï¼Ÿ<br>è‡³æ­¤ï¼Œå¯¹äº<code>ReentrantLock</code>çš„<code>lock()</code>çš„å®ç°ï¼Œè¿˜å‰©ä¸€æ­¥<code>unparkSuccessor()</code>æ¥å”¤é†’åç»­èŠ‚ç‚¹ï¼Œè¿™ä¸ªç•™åœ¨æ¥ä¸‹æ¥è¦å­¦ä¹ çš„<code>unlock()</code>å®ç°ä¸­æ¥åˆ†æã€‚</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2019/05/10/AQS-1/" itemprop="url">
                  AQSæºç è§£æï¼ˆ1ï¼‰
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2019-05-10T17:05:52+08:00" content="2019-05-10">
              2019-05-10
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>CLHï¼ˆCraig, Landin, and Hagerstenï¼‰é”å¸¸ç”¨äºå®ç°è‡ªæ—‹é”ï¼ŒAQSä½¿ç”¨ä¸€ç§å˜å½¢åçš„CLHé”é˜Ÿåˆ—ï¼Œæ¥ä»£æ›¿é˜»å¡åŒæ­¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">     +------+  prev +-----+       +-----+</span><br><span class="line">head |      | &lt;---- |     | &lt;---- |     |  tail</span><br><span class="line">     +------+       +-----+       +-----+</span><br></pre></td></tr></table></figure>

<p>AQSä½¿ç”¨åŒå‘é˜Ÿåˆ—ï¼Œæ¯ä¸€ä¸ªNodeéƒ½ä»£è¡¨ä¸€ä¸ªçº¿ç¨‹ï¼Œæœ‰statuså±æ€§ï¼Œæ ‡è®°ç€çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡ï¼ŒprevæŒ‡é’ˆæŒ‡å‘å‰ä¸ªèŠ‚ç‚¹ï¼ŒnextæŒ‡é’ˆï¼ˆå›¾ä¸­æ²¡æœ‰ç”»å‡ºï¼‰æŒ‡å‘åç»­èŠ‚ç‚¹ï¼Œheadå’Œtailä¸è¨€è€Œå–»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** AbstractQueuedSynchronizer#Node.java **/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¤„äºå…±äº«æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„äºç‹¬å æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºçº¿ç¨‹å–æ¶ˆã€‚ï¼ˆå› ä¸ºä¸­æ–­æˆ–è€…è¶…æ—¶ï¼Œä¸ä¼šå†å‚ä¸åˆ°ç«äº‰ä¸­ï¼ŒçŠ¶æ€ä¹Ÿä¸å†æ”¹å˜ï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è¡¨ç¤ºåç»­çº¿ç¨‹ç­‰å¾…é‡Šæ”¾ã€‚ï¼ˆå› ä¸ºåç»­èŠ‚ç‚¹è¢«é˜»å¡ï¼Œå¤„äºç­‰å¾…çŠ¶æ€ï¼Œéœ€è¦å½“å‰èŠ‚ç‚¹é‡Šæ”¾æˆ–è€…å–æ¶ˆï¼Œä¹‹åä¼šé€šçŸ¥åç»­èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è¡¨ç¤ºçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¡ä»¶ã€‚ï¼ˆçº¿ç¨‹æ­£å¤„äºConditioné˜Ÿåˆ—ä¸­ç­‰å¾…æ¡ä»¶ï¼Œç›´åˆ°çŠ¶æ€è½¬å˜ä¸º0ï¼Œæ‰ä¼šè¢«ç”¨äºåŒæ­¥é˜Ÿåˆ—ä¸­ï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è¡¨ç¤ºä¸‹ä¸€æ¬¡å…±äº«å¼acquireå°†æ— æ¡ä»¶ä¼ æ’­ã€‚(å…±äº«å¼releaseä¼šä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œåœ¨doReleaseSharedæ–¹æ³•ä¸­)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç­‰å¾…çŠ¶æ€ï¼Œåˆå§‹åŒ–ä¸º0ï¼Œéè´Ÿæ•°è¡¨ç¤ºèŠ‚ç‚¹æ— éœ€è¢«é€šçŸ¥</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šè¯¥èŠ‚ç‚¹çš„å…ˆå‰èŠ‚ç‚¹å¦‚æœæ˜¯CANCELLEDçš„ï¼Œå°±å¾€å‰æ‰¾ç¬¬ä¸€ä¸ªéCANCELLEDçš„ï¼Œè‚¯å®šèƒ½æ‰¾åˆ°ä¸€ä¸ªï¼Œå› ä¸ºè‡³å°‘å¤´èŠ‚ç‚¹å°±ä¸æ˜¯CANCELLEDã€‚</span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šåªæœ‰è¯¥èŠ‚ç‚¹æˆä¸ºå°¾èŠ‚ç‚¹æ—¶æ‰ä¼šç»™å…ˆå‰èŠ‚ç‚¹çš„nextåŸŸèµ‹å€¼</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹ç»‘å®šçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…conditonçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆç‹¬å æ¨¡å¼ï¼‰ï¼Œæˆ–è€…SHARED(å…±äº«æ¨¡å¼)</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">        Node p = prev;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, Node mode) &#123;</span><br><span class="line">        <span class="comment">// addWaiteræ–¹æ³•ä½¿ç”¨</span></span><br><span class="line">        <span class="keyword">this</span>.nextWaiter = mode;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, <span class="keyword">int</span> waitStatus) &#123; </span><br><span class="line">        <span class="keyword">this</span>.waitStatus = waitStatus;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å†çœ‹ä¸€ä¸‹AQSå®šä¹‰çš„åŸŸï¼Œç‰¹åˆ«è¦æ³¨æ„è¿™é‡Œçš„<code>state</code>ï¼Œè¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä¸Šæ–‡ä¸­çš„çº¿ç¨‹ç­‰å¾…çŠ¶æ€<code>waitStatus</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤´èŠ‚ç‚¹ï¼Œé€šè¿‡setHeadæ–¹æ³•ä¿®æ”¹ï¼Œç­‰å¾…çŠ¶æ€ä¸èƒ½æ˜¯CANCELLED</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°¾èŠ‚ç‚¹ï¼Œå…¥é˜Ÿæ—¶å¢åŠ </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒæ­¥çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> spinForTimeoutThreshold = <span class="number">1000L</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> newState)</span> </span>&#123;</span><br><span class="line">    state = newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AQSçš„ä¸€äº›åŒ…è£…UnSafeçš„CASæ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> stateOffset;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> waitStatusOffset;</span><br><span class="line"><span class="comment">// ...çœç•¥ headOffsetã€tailOffsetã€nextOffset</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        stateOffset = unsafe.objectFieldOffset</span><br><span class="line">            (AbstractQueuedSynchronizer.class.getDeclaredField(<span class="string">"state"</span>));</span><br><span class="line">        waitStatusOffset = unsafe.objectFieldOffset</span><br><span class="line">            (Node.class.getDeclaredField(<span class="string">"waitStatus"</span>));</span><br><span class="line">        <span class="comment">// ...çœç•¥ headOffsetã€tailOffsetã€nextOffset</span></span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Error(ex); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CASåŒæ­¥çŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetState</span><span class="params">(<span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, stateOffset, expect, update);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// å…¥é˜Ÿæ—¶å¦‚æœé˜Ÿç©ºCASå¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetHead</span><span class="params">(Node update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapObject(<span class="keyword">this</span>, headOffset, <span class="keyword">null</span>, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¥é˜Ÿæ—¶CASå°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetTail</span><span class="params">(Node expect, Node update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapObject(<span class="keyword">this</span>, tailOffset, expect, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CASèŠ‚ç‚¹ç­‰å¾…çŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetWaitStatus</span><span class="params">(Node node,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                     <span class="keyword">int</span> expect,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                     <span class="keyword">int</span> update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(node, waitStatusOffset,</span><br><span class="line">                                    expect, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CASèŠ‚ç‚¹nextåŸŸ</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetNext</span><span class="params">(Node node,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               Node expect,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               Node update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapObject(node, nextOffset, expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ã€é¢˜å¤–è¯ã€‘è¡¥å……ä¸€ä¸‹ï¼Œå› ä¸ºUnSafeåšäº†å®‰å…¨éªŒè¯ï¼Œåªå…è®¸ä¿¡ä»»çš„JDKè°ƒç”¨ï¼Œå¦‚æœä½¿ç”¨å¦‚ä¸Šæ‰€ç¤ºçš„<code>Unsafe.getUnsafe()</code>æˆ–è€…ç›´æ¥å®ä¾‹åŒ–ï¼Œé‚£ä¹ˆä¼šæŠ›<code>Caused by: java.lang.SecurityException: Unsafe</code>çš„å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡åå°„å…¶å†…éƒ¨çš„<code>theUnsafe</code>çš„åŸŸæ¥è¿›è¡Œå®ä¾‹åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Field f = Unsafe.class.getDeclaredField(<span class="string">"theUnsafe"</span>); <span class="comment">//Internal reference</span></span><br><span class="line">f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Unsafe unsafe = (Unsafe) f.get(<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>


            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2019/05/10/Java-Time-API/" itemprop="url">
                  Java Time API
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2019-05-10T14:57:18+08:00" content="2019-05-10">
              2019-05-10
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>ä¸€ã€java.util<br>java.util åŒ…æä¾›äº† Date ç±»æ¥å°è£…å½“å‰çš„æ—¥æœŸå’Œæ—¶é—´ã€‚ Date ç±»æä¾›ä¸¤ä¸ªæ„é€ å‡½æ•°æ¥å®ä¾‹åŒ– Date å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰æ—¥æœŸï¼Œè¾“å‡ºï¼šFri May 10 14:15:23 CST 2019</span></span><br><span class="line">System.out.println(<span class="keyword">new</span> Date()); </span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¼å¼åŒ–æ—¥æœŸï¼Œè¾“å‡ºï¼š2019-05-10 14:18:03</span></span><br><span class="line">System.out.println(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()));  </span><br><span class="line"></span><br><span class="line"><span class="comment">// å­—ç¬¦ä¸²æ—¥æœŸè§£æï¼Œè¾“å‡ºï¼šSun May 05 12:30:05 CST 2019</span></span><br><span class="line">String dateStr = <span class="string">"2019-05-05 12:30:05"</span>;</span><br><span class="line">System.out.println(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).parse(dateStr));</span><br></pre></td></tr></table></figure>

<p>äºŒã€java.time<br>è¿™ä¸ªåŒ…æ˜¯åœ¨Java8ä¸­å¼•å…¥çš„ã€‚åœ¨Java 8ä¹‹å‰ï¼Œæ‰€æœ‰å…³äºæ—¶é—´å’Œæ—¥æœŸçš„APIéƒ½å­˜åœ¨å„ç§ä½¿ç”¨æ–¹é¢çš„ç¼ºé™·ï¼Œä¸»è¦æœ‰ï¼š</p>
<ol>
<li>Javaçš„<code>java.util.Date</code>å’Œ<code>java.util.Calendar</code>ç±»æ˜“ç”¨æ€§å·®ï¼Œä¸æ”¯æŒæ—¶åŒºï¼Œè€Œä¸”ä»–ä»¬éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›</li>
<li>ç”¨äºæ ¼å¼åŒ–æ—¥æœŸçš„ç±»<code>DateFormat</code>è¢«æ”¾åœ¨<code>java.text</code>åŒ…ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ª<code>SimpleDateFormat</code>å¯¹è±¡æ¥å¤„ç†æ—¥æœŸæ ¼å¼åŒ–ï¼Œå¹¶ä¸”<code>DateFormat</code>ä¹Ÿæ˜¯éçº¿ç¨‹å®‰å…¨ï¼Œè¿™æ„å‘³ç€å¦‚æœä½ åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­è°ƒç”¨åŒä¸€ä¸ª<code>DateFormat</code>å¯¹è±¡ï¼Œä¼šå¾—åˆ°æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚</li>
<li>å¯¹æ—¥æœŸçš„è®¡ç®—æ–¹å¼ç¹çï¼Œè€Œä¸”å®¹æ˜“å‡ºé”™ï¼Œå› ä¸ºæœˆä»½æ˜¯ä»0å¼€å§‹çš„ï¼Œä»<code>Calendar</code>ä¸­è·å–çš„æœˆä»½éœ€è¦åŠ ä¸€æ‰èƒ½è¡¨ç¤ºå½“å‰æœˆä»½ã€‚</li>
</ol>
<p>å¢åŠ çš„APIï¼š</p>
<ol>
<li><p>LocalDate è¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„æ—¥æœŸï¼Œä¸åŒ…å«å…·ä½“çš„æ—¶é—´å’Œæ—¶åŒºä¿¡æ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LocalDate now = LocalDate.now();                    <span class="comment">// å½“å‰æ—¥æœŸ</span></span><br><span class="line">LocalDate localDate = LocalDate.of(<span class="number">2017</span>, <span class="number">1</span>, <span class="number">4</span>);     <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªæ—¥æœŸï¼š2017-01-04</span></span><br><span class="line"><span class="keyword">int</span> year = localDate.getYear();                     <span class="comment">// å¹´ä»½ï¼š2017</span></span><br><span class="line">Month month = localDate.getMonth();                 <span class="comment">// æœˆä»½ï¼šJANUARY</span></span><br><span class="line"><span class="keyword">int</span> dayOfMonth = localDate.getDayOfMonth();         <span class="comment">// æœˆä»½ä¸­çš„ç¬¬å‡ å¤©ï¼š4</span></span><br><span class="line">DayOfWeek dayOfWeek = localDate.getDayOfWeek();     <span class="comment">// ä¸€å‘¨çš„ç¬¬å‡ å¤©ï¼šWEDNESDAY</span></span><br><span class="line"><span class="keyword">int</span> length = localDate.lengthOfMonth();             <span class="comment">// æœˆä»½çš„å¤©æ•°ï¼š31</span></span><br><span class="line"><span class="keyword">boolean</span> leapYear = localDate.isLeapYear();          <span class="comment">// æ˜¯å¦ä¸ºé—°å¹´ï¼šfalse</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>LocalTime è¡¨ç¤ºä¸€å¥åŒ…å«å…·ä½“æ—¶é—´çš„æ—¥æœŸ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LocalTime localTime = LocalTime.of(<span class="number">17</span>, <span class="number">23</span>, <span class="number">52</span>);     <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªæ—¶é—´ï¼š17:23:52</span></span><br><span class="line"><span class="keyword">int</span> hour = localTime.getHour();                     <span class="comment">// æ—¶ï¼š17</span></span><br><span class="line"><span class="keyword">int</span> minute = localTime.getMinute();                 <span class="comment">// åˆ†ï¼š23</span></span><br><span class="line"><span class="keyword">int</span> second = localTime.getSecond();                 <span class="comment">// ç§’ï¼š52</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>LocalDateTime æ˜¯LocalDateå’ŒLocalTimeçš„ç»“åˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LocalDateTime ldt1 = LocalDateTime.of(<span class="number">2017</span>, Month.JANUARY, <span class="number">4</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">52</span>);</span><br><span class="line">LocalDate localDate = LocalDate.of(<span class="number">2017</span>, Month.JANUARY, <span class="number">4</span>);</span><br><span class="line">LocalTime localTime = LocalTime.of(<span class="number">17</span>, <span class="number">23</span>, <span class="number">52</span>);</span><br><span class="line">LocalDateTime ldt2 = localDate.atTime(localTime);</span><br><span class="line"></span><br><span class="line"><span class="comment">// LocalDateä¸LocalTimeçš„è½¬åŒ–</span></span><br><span class="line">LocalDate date = ldt1.toLocalDate();</span><br><span class="line">LocalTime time = ldt1.toLocalTime();</span><br></pre></td></tr></table></figure>
</li>
<li><p>Instant è¡¨ç¤ºä¸€ä¸ªç²¾ç¡®åˆ°çº³ç§’çš„æ—¶é—´æˆ³ï¼Œ<code>System.currentTimeMillis()</code>åªç²¾ç¡®åˆ°æ¯«ç§’</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰æ—¶é—´æˆ³</span></span><br><span class="line">Instant now = Instant.now()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ofEpochSecond()æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç§’ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºçº³ç§’</span></span><br><span class="line"><span class="comment">// è¡¨ç¤ºä»1970-01-01 00:00:00å¼€å§‹åä¸¤åˆ†é’Ÿçš„10ä¸‡çº³ç§’çš„æ—¶åˆ»</span></span><br><span class="line"><span class="comment">// è¾“å‡º1970-01-01T00:02:00.000100Z</span></span><br><span class="line">Instant instant = Instant.ofEpochSecond(<span class="number">120</span>, <span class="number">100000</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Duration è¡¨ç¤ºä¸€ä¸ªç²¾ç¡®åˆ°çº³ç§’çš„æ—¶é—´æ®µ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2017-01-05 10:07:00</span></span><br><span class="line">LocalDateTime from = LocalDateTime.of(<span class="number">2017</span>, Month.JANUARY, <span class="number">5</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">0</span>);    </span><br><span class="line"></span><br><span class="line"><span class="comment">// 2017-02-05 10:07:00</span></span><br><span class="line">LocalDateTime to = LocalDateTime.of(<span class="number">2017</span>, Month.FEBRUARY, <span class="number">5</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨ç¤ºä» 2017-01-05 10:07:00 åˆ° 2017-02-05 10:07:00 è¿™æ®µæ—¶é—´</span></span><br><span class="line">Duration duration = Duration.between(from, to);     </span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> days = duration.toDays();              <span class="comment">// è¿™æ®µæ—¶é—´çš„æ€»å¤©æ•°</span></span><br><span class="line"><span class="keyword">long</span> hours = duration.toHours();            <span class="comment">// è¿™æ®µæ—¶é—´çš„å°æ—¶æ•°</span></span><br><span class="line"><span class="keyword">long</span> minutes = duration.toMinutes();        <span class="comment">// è¿™æ®µæ—¶é—´çš„åˆ†é’Ÿæ•°</span></span><br><span class="line"><span class="keyword">long</span> seconds = duration.getSeconds();       <span class="comment">// è¿™æ®µæ—¶é—´çš„ç§’æ•°</span></span><br><span class="line"><span class="keyword">long</span> milliSeconds = duration.toMillis();    <span class="comment">// è¿™æ®µæ—¶é—´çš„æ¯«ç§’æ•°</span></span><br><span class="line"><span class="keyword">long</span> nanoSeconds = duration.toNanos();      <span class="comment">// è¿™æ®µæ—¶é—´çš„çº³ç§’æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡of()æ–¹æ³•åˆ›å»ºï¼Œæ¥å—ä¸€ä¸ªæ—¶é—´æ®µé•¿åº¦ï¼Œå’Œä¸€ä¸ªæ—¶é—´å•ä½ä½œä¸ºå‚æ•°</span></span><br><span class="line">Duration duration1 = Duration.of(<span class="number">5</span>, ChronoUnit.DAYS);       <span class="comment">// 5å¤©</span></span><br><span class="line">Duration duration2 = Duration.of(<span class="number">1000</span>, ChronoUnit.MILLIS);  <span class="comment">// 1000æ¯«ç§’</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Period è¡¨ç¤ºä»¥å¹´æœˆæ—¥æ¥è¡¡é‡æ—¶é—´æ®µ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é•¿åº¦ä¸º2å¹´3ä¸ªæœˆ6å¤©çš„æ—¶é—´æ®µ</span></span><br><span class="line">Period period = Period.of(<span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">/ /é€šè¿‡between()æ–¹æ³•åˆ›å»ºï¼Œåªæ¥æ”¶LocalDateç±»å‹çš„å‚æ•°</span><br><span class="line"><span class="comment">// 2017-01-05 åˆ° 2017-02-05 è¿™æ®µæ—¶é—´</span></span><br><span class="line">Period period = Period.between(</span><br><span class="line">                LocalDate.of(<span class="number">2017</span>, <span class="number">1</span>, <span class="number">5</span>),</span><br><span class="line">                LocalDate.of(<span class="number">2017</span>, <span class="number">2</span>, <span class="number">5</span>));</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>ç›¸å…³æ“ä½œï¼š</p>
<ol>
<li><p>ä¸åŸæœ‰APIçš„è½¬åŒ–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dateè½¬LocalDate</span></span><br><span class="line">Date date = <span class="keyword">new</span> Date();</span><br><span class="line">LocalDateTime localDateTime = date.toInstant().atZone(ZoneId.systemDefault()).toLocalDateTime();</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¢åŠ å’Œå‡å°‘æ—¥æœŸ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LocalDate date = LocalDate.of(<span class="number">2017</span>, <span class="number">1</span>, <span class="number">5</span>);          <span class="comment">// 2017-01-05</span></span><br><span class="line"></span><br><span class="line">LocalDate date1 = date.withYear(<span class="number">2016</span>);              <span class="comment">// ä¿®æ”¹ä¸º 2016-01-05</span></span><br><span class="line">LocalDate date2 = date.withMonth(<span class="number">2</span>);                <span class="comment">// ä¿®æ”¹ä¸º 2017-02-05</span></span><br><span class="line">LocalDate date3 = date.withDayOfMonth(<span class="number">1</span>);           <span class="comment">// ä¿®æ”¹ä¸º 2017-01-01</span></span><br><span class="line"></span><br><span class="line">LocalDate date4 = date.plusYears(<span class="number">1</span>);                <span class="comment">// å¢åŠ ä¸€å¹´ 2018-01-05</span></span><br><span class="line">LocalDate date5 = date.minusMonths(<span class="number">2</span>);              <span class="comment">// å‡å°‘ä¸¤ä¸ªæœˆ 2016-11-05</span></span><br><span class="line">LocalDate date6 = date.plus(<span class="number">5</span>, ChronoUnit.DAYS);    <span class="comment">// å¢åŠ 5å¤© 2017-01-10</span></span><br><span class="line"></span><br><span class="line">LocalDate date7 = date.with(nextOrSame(DayOfWeek.SUNDAY));      <span class="comment">// è¿”å›ä¸‹ä¸€ä¸ªè·ç¦»å½“å‰æ—¶é—´æœ€è¿‘çš„æ˜ŸæœŸæ—¥</span></span><br><span class="line">LocalDate date9 = date.with(lastInMonth(DayOfWeek.SATURDAY));   <span class="comment">// è¿”å›æœ¬æœˆæœ€åä¸€ä¸ªæ˜ŸæœŸå…­</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ ¼å¼åŒ–æ—¥æœŸ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LocalDateTime dateTime = LocalDateTime.now();</span><br><span class="line">String strDate1 = dateTime.format(DateTimeFormatter.BASIC_ISO_DATE);    <span class="comment">// 20170105</span></span><br><span class="line">String strDate2 = dateTime.format(DateTimeFormatter.ISO_LOCAL_DATE);    <span class="comment">// 2017-01-05</span></span><br><span class="line">String strDate3 = dateTime.format(DateTimeFormatter.ISO_LOCAL_TIME);    <span class="comment">// 14:20:16.998</span></span><br><span class="line">String strDate4 = dateTime.format(DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd"</span>));   <span class="comment">// 2017-01-05</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»Šå¤©æ˜¯ï¼š2017å¹´ ä¸€æœˆ 05æ—¥ æ˜ŸæœŸå››</span></span><br><span class="line">String strDate5 = dateTime.format(DateTimeFormatter.ofPattern(<span class="string">"ä»Šå¤©æ˜¯ï¼šYYYYå¹´ MMMM DDæ—¥ E"</span>, Locale.CHINESE)); </span><br><span class="line"></span><br><span class="line">String strDate6 = <span class="string">"2017-01-05"</span>;</span><br><span class="line">String strDate7 = <span class="string">"2017-01-05 12:30:05"</span>;</span><br><span class="line"></span><br><span class="line">LocalDate date = LocalDate.parse(strDate6, DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd"</span>));</span><br><span class="line">LocalDateTime dateTime1 = LocalDateTime.parse(strDate7, DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ—¶åŒºä¸å†æ³•ï¼Œè§å‚è€ƒï¼Œè¿™é‡Œä¸è´´äº†</p>
</li>
</ol>
<p>å‚è€ƒ<br>[1] <a href="https://lw900925.github.io/java/java8-newtime-api.html" target="_blank" rel="noopener">Java 8æ–°ç‰¹æ€§ï¼ˆå››ï¼‰ï¼šæ–°çš„æ—¶é—´å’Œæ—¥æœŸAPI</a><br>[2] <a href="[http://www.importnew.com/14140.html](http://www.importnew.com/14140.html)">Java8 æ—¥æœŸ/æ—¶é—´ï¼ˆDate Timeï¼‰APIæŒ‡å—</a><br>[3] <a href="https://www.runoob.com/java/java-date-time.html" target="_blank" rel="noopener">Java æ—¥æœŸæ—¶é—´</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2019/05/07/hexo-2/" itemprop="url">
                  æ¢ç”µè„‘åHexoæ›´æ–°
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2019-05-07T11:58:18+08:00" content="2019-05-07">
              2019-05-07
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Hexo/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>ç°åœ¨å¤§éƒ¨åˆ†æ—¶é—´ä½¿ç”¨å…¬å¸ç”µè„‘ï¼Œäºæ˜¯æä¸€ä¸‹ã€‚<br>ä¸»è¦å‚è€ƒè¿™ä¸ª<a href="https://www.zhihu.com/question/21193762" target="_blank" rel="noopener">è§£å†³åŠæ³•</a>ï¼Œmasteråˆ†æ”¯ä¸Šæ˜¯ç”Ÿæˆçš„é¡µé¢æ–‡ä»¶ï¼Œhexoåˆ†æ”¯ä¸Šæ˜¯æºæ–‡ä»¶ï¼Œè®¾ç½®hexoä¸ºé»˜è®¤åˆ†æ”¯ã€‚<br>é‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¤šä¸ªgitè´¦å·ï¼Œå‚è€ƒè¿™ä¸ª<a href="https://www.jianshu.com/p/b02645fff791" target="_blank" rel="noopener">è§£å†³åŠæ³•</a>ï¼Œä¸»è¦æ€è·¯æ˜¯åœ¨sshä¸­å¢åŠ ä¸€ä¸ªconfigæ–‡ä»¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># åˆ«åï¼Œå¯ä»¥éšä¾¿å–</span><br><span class="line">Host github</span><br><span class="line">    User git</span><br><span class="line">    Hostname github.com</span><br><span class="line">    IdentityFile ~/.ssh/github_id_rsa</span><br><span class="line"></span><br><span class="line">Host gitlab</span><br><span class="line">    User git</span><br><span class="line">    Hostname gitlab.xxx.com</span><br><span class="line">    IdentityFile ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸ªå°å°çš„å‘ï¼Œå°±æ˜¯ä¹‹å‰è®¾ç½®äº†git config â€”globalï¼Œåœ¨hexo deployæ—¶ä¼šä½¿ç”¨å…¨å±€é…ç½®çš„ç”¨æˆ·åè¿›è¡Œï¼Œéœ€è¦åœ¨hexoçš„é¡¹ç›®ä¸­é…ç½®å±€éƒ¨è®¾ç½®ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git config user.name <span class="string">"A"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git config user.email <span class="string">"A@gmail.com"</span></span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±ä¼šä½¿ç”¨é…ç½®åçš„å±€éƒ¨ç”¨æˆ·åè¿›è¡Œpushã€‚</p>
<p>å…¶æ¬¡å°±æ˜¯ä¸è¦ç”¨hexo initå‘½ä»¤ã€‚åŸå› æ˜¯å½“å‰ç›®å½•å·²ç»å»ºç«‹äº†gitä»“åº“ç¯å¢ƒ, hexo initä¼šè¦†ç›–åˆ°å½“å‰çš„gitç¯å¢ƒï¼Œé‡å»ºä¸€ä¸ªæ–°çš„ï¼Œè¿™æ ·å’Œæˆ‘ä»¬çš„ç§æœ‰Hexoæºç ä»“åº“è„±ç¦»äº†è”ç³»ã€‚<br>æœ€åï¼Œç”±äºåœ¨ymlæ–‡ä»¶å·²ç»é…ç½®äº†deployçš„branchæ˜¯masterï¼Œæ‰€ä»¥æ‰§è¡Œhexo dæ—¶è¿˜æ˜¯ä¼šå°†é¡µé¢æ–‡ä»¶ä¿å­˜è‡³masterï¼Œè€Œæºæ–‡ä»¶éœ€è¦æ‰‹åŠ¨pushåˆ°hexoåˆ†æ”¯ä¸Šã€‚</p>
<p>ä¸€äº›hexoå¸¸ç”¨å‘½ä»¤ï¼š<br><code>hexo new newpage  # æ–°å»º</code><br><code>hexo g  # ç”Ÿæˆ</code><br><code>hexo s  # æœ¬åœ°é¢„è§ˆ</code><br><code>hexo d  # éƒ¨ç½²</code></p>
<p>å¦å¤–ï¼Œåœ¨macä¸Šå‘ç°äº†ä¸€æ¬¾markdownç¥å™¨â€”â€”<a href="https://typora.io/" target="_blank" rel="noopener">typora</a><br>æ³¨æ„ä¸€ä¸‹ï¼Œç›´æ¥ä½¿ç”¨å›è½¦ä¼šæœ‰ç©ºè¡Œï¼Œä½¿ç”¨shift+å›è½¦å°±å¯ä»¥æ²¡æœ‰ç©ºè¡Œäº†ã€‚</p>
<p>ä¸€äº›typoraå¸¸ç”¨å¿«æ·é”®ï¼š<br>è¶…é“¾æ¥  <code>âŒ˜ + k</code><br>ä»£ç å— <code>âŒƒ + `</code></p>
<p>ps1: <a href="https://sspai.com/post/36242" target="_blank" rel="noopener">macæŠ€æœ¯ç¬¦å·è¾“å…¥</a><br>ps2: å¦‚æœä¸¤ä¸ªé‡éŸ³ç¬¦<code>`</code>ä¸­é—´çš„å†…å®¹ä¹ŸåŒ…å«é‡éŸ³ç¬¦ï¼Œåˆ™åœ¨æœ€å¤–å±‚éœ€è¦ç”¨<strong>ä¸¤ä¸ªè¿ç»­é‡éŸ³ç¬¦</strong>å¤¹èµ·æ¥</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/05/04/Leetcode15/" itemprop="url">
                  Leetcode-15 Three Sum
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2017-05-04T21:45:56+08:00" content="2017-05-04">
              2017-05-04
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">Leetcode</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <hr>
<p>é¢˜ç›®è¦æ±‚ï¼šç»™å®šä¸€ä¸ªæ•°ç»„numsï¼Œæ‰¾å‡ºå’Œä¸º0çš„æ‰€æœ‰ä¸‰å…ƒç»„é›†åˆã€‚</p>
<p>ç¤ºä¾‹ï¼šnums = [-1, 0, 1, 2, -1, -4]ï¼Œå’Œä¸º0çš„ä¸‰å…ƒç»„é›†åˆ = [[-1, 0, 1], [-1, -1, 2]]ã€‚</p>
<p>æ€è·¯ï¼šå°†æ•°ç»„æ’åºåï¼ŒæŒ‡é’ˆæŒ‡å®šä¸€ä¸ªå…ƒç´ åï¼Œå¯¹è¯¥å…ƒç´ ä¹‹åçš„å…ƒç´ è¿›è¡Œ2sumè¿ç®—ï¼Œè€ƒè™‘åˆ°ä¸èƒ½æœ‰é‡å¤ç»“æœï¼Œæ‰€ä»¥éœ€è¦è·³è¿‡é‡å¤å…ƒç´ ã€‚</p>
<p>ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">import java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public class Solution &#123;</span><br><span class="line">    public List&lt;List&lt;Integer&gt;&gt; threeSum(int[] nums) &#123;</span><br><span class="line">        int N = nums.length;</span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; result = new ArraysList&lt;&gt;();</span><br><span class="line">        if (nums == null || N == 0 || N &lt; 3)</span><br><span class="line">            return result;</span><br><span class="line">        Arrays.sort(nums);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; N-2; i++) &#123;</span><br><span class="line">            // è·³è¿‡é‡å¤å…ƒç´ </span><br><span class="line">            if (i &gt; 0 &amp;&amp; num[i-1] == nums[i])</span><br><span class="line">                continue;</span><br><span class="line">            int left = i + 1;</span><br><span class="line">            int right = N - 1;</span><br><span class="line">            int target = -nums[i];</span><br><span class="line">            // å¯¹ä¹‹åçš„å…ƒç´ è¿›è¡Œ2sum</span><br><span class="line">            twoSum(nums, left, right, target, result);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void twoSum(int[] nums, int left, int right, int target, List&lt;List&lt;Integer&gt;&gt; result) &#123;</span><br><span class="line">        while (left &lt; right) &#123;</span><br><span class="line">            if (nums[left] + nums[right] == target) &#123;</span><br><span class="line">                List&lt;Integer&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">                list.add(-target);</span><br><span class="line">                list.add(nums[left]);</span><br><span class="line">                list.add(nums[right]);</span><br><span class="line">                result.add(list);</span><br><span class="line"></span><br><span class="line">                left++;</span><br><span class="line">                right--;</span><br><span class="line"></span><br><span class="line">                // ä»å·¦è¾¹è·³è¿‡é‡å¤å…ƒç´ </span><br><span class="line">                while (left &lt; right &amp;&amp; nums[left-1] == nums[left])</span><br><span class="line">                    left++;</span><br><span class="line">                // ä»å³è¾¹è·³è¿‡é‡å¤å…ƒç´ </span><br><span class="line">                while (left &lt; right &amp;&amp; nums[right] == nums[right+1])</span><br><span class="line">                    right--;</span><br><span class="line">            &#125;</span><br><span class="line">            // å’Œå°äºtargetï¼Œå¢å¤§leftçš„å€¼</span><br><span class="line">            else if (nums[left] + nums[right] &lt; target)</span><br><span class="line">                left++;</span><br><span class="line">            // å’Œå¤§äºtargetï¼Œå‡å°rightçš„å€¼</span><br><span class="line">            else</span><br><span class="line">                right--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/05/03/Leetcode11/" itemprop="url">
                  Leetcode-11 Container With Most Water
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2017-05-03T21:12:55+08:00" content="2017-05-03">
              2017-05-03
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">Leetcode</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <hr>
<p>é¢˜ç›®è¦æ±‚ï¼šç»™å®šä¸€ä¸ªéè´Ÿçš„æ•´å‹æ•°ç»„ï¼Œå…ƒç´ a[i]ä»£è¡¨åæ ‡(i, a[i])ï¼Œå¾—åˆ°ä¸€ç»„æ¯ä¸ªç‚¹åˆ°xè½´çš„å‚çº¿ï¼Œé€‰å‡ºä¸¤æ¡å‚çº¿å’Œxè½´æ„æˆæ°´ç®±ï¼Œæ±‚å›´æˆçš„æœ€å¤§çš„é¢ç§¯ã€‚</p>
<p>æ€è·¯ï¼š<br>å·¦å³ä¸¤ä¸ªæŒ‡é’ˆæ‰«ææ•°ç»„ï¼Œè®¡ç®—é¢ç§¯ã€‚å‡è®¾æ‰¾åˆ°æœ€ä½³çš„ä¸¤æ¡çº¿ä¸ºleftï¼Œrightï¼Œæ˜“çŸ¥leftå·¦è¾¹æ²¡æœ‰æ¯”leftæ›´é«˜çš„å‚çº¿ï¼Œrightå³è¾¹æ²¡æœ‰æ¯”rightæ›´é«˜çš„å‚çº¿ï¼Œå³æœ€ä½³çš„ç»„åˆåœ¨å½“å‰å€™é€‰çš„leftå’Œrightçš„èŒƒå›´å†…ã€‚æ”¶ç¼©åº•è¾¹é•¿åº¦ï¼Œå¢å¤§é«˜ï¼Œå½“leftçš„é«˜åº¦å¤§äºrightçš„ï¼Œrightå‘å·¦æ‰«æï¼Œåä¹‹leftå‘å³æ‰«æï¼Œæ±‚å‡ºæœ€å¤§é¢ç§¯ã€‚</p>
<p>ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line">    public int maxArea(int[] height) &#123;</span><br><span class="line">        int N = height.length;</span><br><span class="line">        if (N &lt; 2)</span><br><span class="line">            return 0;</span><br><span class="line">        int maxArea = 0;</span><br><span class="line">        int left = 0;</span><br><span class="line">        int right = N - 1;</span><br><span class="line">        while (left &lt; right) &#123;</span><br><span class="line">            int currArea = (right - left) * Math.min(height[left], height[right]);</span><br><span class="line">            maxArea = Math.max(maxArea, currArea);</span><br><span class="line">            if (height[left] &gt; height[right])</span><br><span class="line">                right--;</span><br><span class="line">            else</span><br><span class="line">                left++;</span><br><span class="line">        &#125;</span><br><span class="line">        return maxArea;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                <a class="post-title-link" href="/2017/04/30/Leetcode4/" itemprop="url">
                  Leetcode-4 Median of Two Sorted Arrays
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            å‘è¡¨äº
            <time itemprop="dateCreated" datetime="2017-04-30T22:07:09+08:00" content="2017-04-30">
              2017-04-30
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; åˆ†ç±»äº
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">Leetcode</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <hr>
<p>é¢˜ç›®è¦æ±‚ï¼šç»™å®šä¸¤ä¸ªæœ‰åºæ•°ç»„nums1ã€nums2ï¼Œæ‰¾åˆ°åˆå¹¶åæ•°ç»„çš„ä¸­ä½æ•°ã€‚</p>
<p>ç¤ºä¾‹ï¼šnums1 = [1, 3]ï¼Œnums2 = [2]ï¼Œä¸­ä½æ•°2.0</p>
<p>æ€è·¯ï¼š</p>
<ol>
<li>ä¼ ç»Ÿæ€è·¯ï¼Œå°†ä¸¤ä¸ªæ•°ç»„åˆå¹¶èµ·æ¥å†æ’åºï¼Œæ‰¾åˆ°ä¸­ä½æ•°ã€‚</li>
<li>å°†é—®é¢˜æ‰©å±•ä¸ºåœ¨ä¸¤ä¸ªæœ‰åºæ•°ç»„ä¸­æ‰¾åˆ°åˆå¹¶åç¬¬Kä¸ªæ•°çš„é—®é¢˜ã€‚</li>
</ol>
<p>ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// é‡‡ç”¨ç¬¬äºŒç§æ€è·¯</span><br><span class="line">public class Solution &#123;</span><br><span class="line">    public double findMedianSortedArrays(int[] nums1, int[] nums2) &#123;</span><br><span class="line">        int m = nums1.length;</span><br><span class="line">        int n = nums2.length;</span><br><span class="line">        int total = m + n;</span><br><span class="line">        // å¥‡æ•°</span><br><span class="line">        if (total % 2 != 0) &#123;</span><br><span class="line">            return findKth(nums1, 0, m-1, nums2, 0, n-1, total/2 + 1);  // ç¬¬total/2+1ä¸ªå…ƒç´  </span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            double x = findKth(nums1, 0, m-1, nums2, 0, n-1, total/2);</span><br><span class="line">            double y = findKth(nums1, 0, m-1, nums2, 0, n-1, total/2 + 1);</span><br><span class="line">            return (x + y) / 2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //  æŒ‡é’ˆä»1å¼€å§‹è®¡æ•°</span><br><span class="line">    private double findKth(int[] a, int aLeft, int aRight, int[] b, int bLeft, int bRight, int k) &#123;</span><br><span class="line">        int m = aRight - aLeft + 1;  // å½“å‰açš„æ‰«æé•¿åº¦</span><br><span class="line">        int n = bRight - bLeft + 1;  // å½“å‰bçš„æ‰«æé•¿åº¦</span><br><span class="line">        if (m &gt; n)</span><br><span class="line">            return findKth(b, bLeft, bRight, a, aLeft, aRight, k);</span><br><span class="line">        if (m == 0)</span><br><span class="line">            return b[k-1];</span><br><span class="line">        if (k == 1)</span><br><span class="line">            return Math.min(a[aLeft], b[bLeft]);</span><br><span class="line"></span><br><span class="line">        int partA = Math.min(m, k/2);  // açš„æŒ‡é’ˆåç§»é‡</span><br><span class="line">        int partB = k - partA;  // aæŒ‡é’ˆåç§»äº†partAï¼Œåœ¨åˆå¹¶åçš„æ•°ç»„ä¸­ï¼ŒbæŒ‡é’ˆåç§»k-partA</span><br><span class="line"></span><br><span class="line">        // aå’Œbå“ªä¸ªåç§»åçš„æ•°å€¼å°ï¼Œè¯´æ˜Kthå¤§äºå“ªä¸ªï¼Œè¯æ˜è§ä¸‹æ–‡ã€‚åˆ™å¯å¿½ç•¥å°äºåç§»é‡çš„é‚£äº›å…ƒç´ ã€‚</span><br><span class="line">        if (a[aLeft + partA - 1] &gt; b[bLeft + partB - 1])</span><br><span class="line">            return findKth(a, aLeft, aRight, b, bLeft+partB, bRight, k-partB);</span><br><span class="line">        else if (a[aLeft + partA - 1] &lt; b[bLeft + partB -1])</span><br><span class="line">            return findKth(a, aLeft+partA, aRight, b, bLeft, bRight, k-partA);</span><br><span class="line">        else</span><br><span class="line">            // a[aLeft+partA-1] == b[bLeft+partB-1]ï¼Œæ‰¾åˆ°Kth</span><br><span class="line">            return a[aLeft + partA - 1];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ†æï¼šè€ƒè™‘ä¸€ç§æƒ…å†µï¼Œå‡è®¾aå’Œbçš„ä¸ªæ•°éƒ½å¤§äºk/2ï¼Œè®¾p=k/2-1ï¼Œå¦‚æœa[p] &lt; b[p]ï¼Œåˆ™åˆå¹¶åKth &gt; a[p]<br>è¯æ˜ï¼šç”¨åè¯æ³•ï¼Œå‡è®¾å½“a[p] &lt; b[p]æ—¶ï¼Œkth &lt; a[p]ï¼Œä¸å¦¨ä»¤a[p]æ˜¯åˆå¹¶åç¬¬k+1ä¸ªæ•°ã€‚äºæ˜¯ï¼Œaä¸­æœ‰pä¸ªæ•°å°äºa[p]ï¼Œç”±å‡è®¾çŸ¥bä¸­æœ€å¤šåªæœ‰pä¸ªæ•°å°äºa[p]ï¼Œæ‰€ä»¥æ€»å…±æœ‰2p=k-2ä¸ªæ•°å°äºa[p]ã€‚a[p]æ˜¯ç¬¬k+1ä¸ªæ•°å¹¶ä¸”a[p]ä¹‹å‰æœ‰k-2ä¸ªæ•°ï¼Œè¿™æ˜¯çŸ›ç›¾çš„ï¼Œæ•…å¾—è¯Kth &gt; a[p]ã€‚<br>åŒç†ï¼Œå½“a[p] &gt; b[p]æ—¶ï¼ŒKth &gt; b[p]ï¼Œå½“a[p] == b[p]æ—¶ï¼ŒKth==a[p]==b[p]</p>
<p>åœ¨æ±‚Kthæ—¶ï¼Œä»ç›¸å¯¹æ›´çŸ­çš„æ•°ç»„å…¥æ‰‹æ¥è®¡ç®—åç§»é‡pï¼Œä¸»è¦æ˜¯æ¯”è¾ƒåç§»åå…ƒç´ çš„å¤§å°ã€‚å¦‚æœæ˜¯ä¸Šæ–‡ä¸­å‡è®¾çš„æƒ…å†µï¼Œåˆ™ç›´æ¥å–k/2ï¼Œå¦åˆ™å–æ•°ç»„é•¿åº¦ï¼Œå³Math.min(k/2, m)ã€‚</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


 </div>

        

        
      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/uploads/avatar.jpg" alt="Carl John" itemprop="image">
          <p class="site-author-name" itemprop="name">Carl John</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">43</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Carl John</span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="http://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.2" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }

      motionIntegrator.bootstrap();
    });
  </script>

  
  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
